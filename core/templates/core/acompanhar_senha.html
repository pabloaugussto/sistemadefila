{% extends 'core/base.html' %}

{% block title %}Acompanhar Senha - SenhaF√°cil{% endblock %}

{% block content %}
<div class="container text-center mt-5">
    <div class="row">
        <div class="col-md-6 offset-md-3">
            <div class="card shadow-lg" id="card-principal">
                <div class="card-header text-center bg-primary text-white">
                    <h2><i class="bi bi-ticket-perforated"></i> Sua Senha: {{ senha }}</h2>
                </div>
                <div class="card-body">
                    
                    <p class="fs-5 mb-1">Status Atual:</p>
                    <h1 class="display-3 fw-bold mb-4" id="status-senha-individual">
                        {% if senha.status == 'AGU' %}AGUARDANDO{% elif senha.status == 'CHA' %}CHAMADA{% elif senha.status == 'ATE' %}EM ATENDIMENTO{% elif senha.status == 'FIN' %}FINALIZADA{% endif %}
                    </h1>

                    <p class="fs-5">Sua posi√ß√£o na fila:</p>
                    <h1 class="display-3 fw-bold mb-4" id="posicao-na-fila">{{ posicao }}¬∫</h1>
                    
                    <hr />

                    <p class="fs-5 mt-4">√öltima senha chamada no painel:</p>
                    <h2 class="display-5 text-success fw-bold" id="senha-chamada">
                        - - -
                    </h2>
                </div>
                <div class="card-footer text-muted" id="card-footer-status">
                    Aguarde a atualiza√ß√£o. N√£o feche esta tela.
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    const senhaIndividual = "{{ senha }}"; // Sua senha, ex: N001
    const statusElement = document.getElementById('status-senha-individual');
    const chamadaElement = document.getElementById('senha-chamada');
    const cardPrincipal = document.getElementById('card-principal');
    const cardFooter = document.getElementById('card-footer-status');

    // CONEX√ÉO COM WEBSOCKETS (Channels)
    const filaSocket = new WebSocket('ws://' + window.location.host + '/ws/fila/');

    filaSocket.onopen = function(e) {
        console.log('Conex√£o WebSocket aberta com sucesso!');
    };

    filaSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        console.log('Mensagem recebida do servidor:', data);
        
        if (data.type === 'fila_update') {
            const fullMessage = data.message; // Ex: "CHAMADA: N005" ou "FINALIZADA: P002"
            
            // L√≥gica para extrair a√ß√£o e senha (ex: ACAO: SENHA)
            const [action, senhaChamada] = fullMessage.split(': ');
            
            // 1. ATUALIZA√á√ÉO GERAL (Mostra a √∫ltima chamada)
            if (action === 'CHAMADA' || action === 'FINALIZADA') {
                chamadaElement.innerText = senhaChamada;
                chamadaElement.classList.add('text-success');
            }
            
            // 2. ATUALIZA√á√ÉO INDIVIDUAL DA SUA SENHA
            if (senhaChamada === senhaIndividual) {
                
                // Remove classes de status antigas
                cardPrincipal.classList.remove('border-danger', 'border-warning', 'border-success', 'border-secondary');

                if (action === 'CHAMADA') {
                    statusElement.innerText = 'CHAMADA';
                    cardPrincipal.classList.add('border-danger');
                    cardFooter.innerText = 'üö® Por favor, dirija-se ao seu atendente!';
                    
                } else if (action === 'FINALIZADA') {
                    statusElement.innerText = 'FINALIZADA';
                    cardPrincipal.classList.add('border-success');
                    cardFooter.innerText = '‚úÖ Seu atendimento foi conclu√≠do!';
                    
                }
                
                // NOTA: Para atualizar a "posi√ß√£o na fila" em tempo real, 
                // voc√™ precisaria fazer uma chamada AJAX para o servidor aqui.
                // Como n√£o temos essa view/rota, a posi√ß√£o s√≥ ser√° atualizada com F5.
            }
        }
    };

    filaSocket.onclose = function(e) {
        console.error('Conex√£o WebSocket fechada inesperadamente.');
    };
</script>
{% endblock %}